<!DOCTYPE html>

<html lang="ru">

<head>
  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  <!-- For russian symbols -->
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <style>
    html, body {
      height: 100%;
    }
  </style>

  <script>
    var map = null;
    var authKey = null;
    var playerMarker = null;
    var host = window.atob('aHR0cHM6Ly9obnljMjAxNy5kZG5zLm5ldDo1NjU4Mg==');

    function error(msg) {
      window.alert(msg);
      window.location = 'index.html';
    }

    function updateGeolocation() {
      navigator.geolocation.getCurrentPosition(function(pos) {
        var position = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };
        playerMarker.setPosition(position);

        // Post player's location to server.
        var playerData = {
          authKey: authKey,
          position: position
        };

        $.ajax({
          type: 'POST',
          url: host + '/geolocation',
          data: JSON.stringify(playerData),
          dataType: 'json',  // Expected response type.
        }).done(function(response) {
          if (!response.error) {
            updateMarkers();
          } else {
            error('Ошибка: ' + response.error);
          }
        }).fail(function() {
          error('Потеряно соединение с сервером.');
        });
      });
    }

    function updateMarkers() {
    }

    function callback() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          var position = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          var mapParams = {
            center: position,
            zoom: 17
          };
          map = new google.maps.Map(document.getElementById("map"), mapParams);

          playerMarker = new google.maps.Marker({
            position: position,
            map: map
          });

          var interval = setInterval(updateGeolocation, 1000);
          $(window).focus(function() {
            interval = setInterval(updateGeolocation, 1000);
          });
          $(window).blur(function() {
            clearInterval(interval);
          });
        });
      } else {
        error('Browser not supports geolocation.');
      }
    }

    $(document).ready(function() {
      var match = document.URL.match(/authKey=(.*)/);
      if (match) {
        authKey = match[1];
        $.getJSON(window.atob('aHR0cHM6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2pzP2tleT1BSXphU3lDODlnWC1RRFpVc0ItWmoxLWRFN0E3VHJSckFKdUhNWGsmY2FsbGJhY2s9Pw=='),
                  callback)
      } else {
        error('Unauthentificated request.');
      }
    });
  </script>

</head>

<body>

  <div id="map" style="width: 100%; height: 100%">
  </div>

</body>

</html>
