<!DOCTYPE html>

<html>

<head>
  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  <style>
    html, body {
      height: 100%;
    }
  </style>

  <script>
    var map = null;
    var authKey = null;
    var markers = [];

    function updateGeolocation() {
      navigator.geolocation.getCurrentPosition(function(pos) {
        // Post player's location to server.
        var playerData = {
          authKey: authKey,
          position: {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          }
        };

        $.ajax({
          type: 'POST',
          url: 'http://localhost:56582/geolocation',
          data: JSON.stringify(playerData),
          dataType: 'json',  // Expected response type.
        }).done(function(res) {
          updateMarkers();
        });
      });
    }

    function updateMarkers() {
      $.ajax({
        type: 'GET',
        url: 'http://localhost:56582/players?authKey=' + authKey,
        dataType: 'json'  // Expected response type.
      }).done(function(res) {
        var players = res.players;
        // Remove old markers (without actual players).
        markers = markers.filter(function(marker) {
          var player = players.find(function(player) {
            return marker.title === player.name;
          });
          if (player !== undefined) {
            return true;
          } else {
            marker.setMap(null);
            return false;
          }
        });

        // Add new markers or update exists.
        players.forEach(function(player) {
          var marker = markers.find(function(marker) {
            return marker.title === player.name;
          });
          if (marker !== undefined) {
            marker.setPosition(player.position);
          } else {
            markers.push(new google.maps.Marker({
              position: player.position,
              map: map,
              title: player.name
            }));
          }
        });
      });
    }

    function callback() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          var mapParams = {
            center: {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            },
            zoom: 17
          };
          map = new google.maps.Map(document.getElementById("map"), mapParams);
          setInterval(updateGeolocation, 1000);
        });
      } else {
        console.log('Browser not supports geolocation');
      }
    }

    $(document).ready(function() {
      // TODO: check authKey existance
      authKey = document.URL.match(/authKey=(.*)/)[1];
      $.getJSON("https://maps.googleapis.com/maps/api/js?callback=?", callback)
    });
  </script>

</head>

<body>

  <div id="map" style="width: 100%; height: 100%">
  </div>

</body>

</html>
